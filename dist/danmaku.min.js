(function(t,i){typeof exports==="object"&&typeof module!=="undefined"?module.exports=i():typeof define==="function"&&define.amd?define(i):t.Danmaku=i()})(this,function(){"use strict";function t(){var t=9007199254740991;return[{range:0,time:-t,width:t,height:0},{range:t,time:t,width:0,height:0}]}var i={};function e(){i.ltr=t();i.rtl=t();i.top=t();i.bottom=t()}e();function s(t){var e=this;var s=this._hasMedia?this.media.currentTime:Date.now()/1e3;function n(t,i){if(i.mode==="top"||i.mode==="bottom"){return s-t.time<e.duration}var n=(e.width+t.width)*(s-t.time)/e.duration;var h=e.duration+t.time-s;var a=e.duration*e.width/(e.width+i.width);return h>a||t.width>n}var h=i[t.mode];var a=h.length;var r=0;var o=0;for(var d=1;d<a;d++){var m=h[d];var u=t.height;if(t.mode==="top"||t.mode==="bottom"){u+=m.height}if(m.range-h[r].range>u){o=d;break}if(n(m,t)){r=d}}var l=h[r].range;var c={range:l+t.height,time:t.time,width:t.width,height:t.height};h.splice(r+1,o-r-1,c);if(t.mode==="bottom"){return this.height-t.height-l%this.height}return l%(this.height-t.height)}function n(t){var i=document.createElement("div");i.textContent=t.text;i.style.cssText="position:absolute;white-space:nowrap;";if(t.style){for(var e in t.style){i.style[e]=t.style[e]}}return i}var h=function(){var t=["oTransform","msTransform","mozTransform","webkitTransform","transform"];var i=document.createElement("div").style;for(var e=t.length-1;e>=0;e--){if(t[e]in i){return t[e]}}return"transform"}();function a(){var t=this._hasMedia?this.media.currentTime:Date.now()/1e3;var i=null;var e=0;for(e=this.runningList.length-1;e>=0;e--){i=this.runningList[e];if(t-i.time>this.duration){this.stage.removeChild(i.node);if(!this._hasMedia){i.node=null}this.runningList.splice(e,1)}}var a=[];var r=document.createDocumentFragment();while(this.position<this.comments.length&&this.comments[this.position].time<t){i=this.comments[this.position];i.node=i.node||n(i);this.runningList.push(i);a.push(i);r.appendChild(i.node);++this.position}if(a.length){this.stage.appendChild(r)}for(e=a.length-1;e>=0;e--){i=a[e];i.width=i.width||i.node.offsetWidth;i.height=i.height||i.node.offsetHeight}for(e=a.length-1;e>=0;e--){i=a[e];i.y=s.call(this,i);if(i.mode==="top"||i.mode==="bottom"){i.x=this.width-i.width>>1;i.node.style[h]="translate("+i.x+"px,"+i.y+"px)"}}for(e=this.runningList.length-1;e>=0;e--){i=this.runningList[e];if(i.mode==="top"||i.mode==="bottom"){continue}var o=(this.width+i.width)*(t-i.time)/this.duration;o|=0;if(i.mode==="ltr")i.x=o-i.width;if(i.mode==="rtl")i.x=this.width-o;i.node.style[h]="translate("+i.x+"px,"+i.y+"px)"}}var r=16;var o=16;function d(t){var i=window.getComputedStyle(t,null).getPropertyValue("font-size").match(/(.+)px/)[1]*1;if(t.tagName==="HTML"){o=i}else{r=i}}var m={};function u(t){if(m[t]){return m[t]}var i=12.31;var e=/^(\d+(?:\.\d+)?)(px|%|em|rem)(?:\s*\/\s*(\d+(?:\.\d+)?)(px|%|em|rem)?)?/;var s=t.match(e);if(s){var n=s[1]*1||10;var h=s[2];var a=s[3]*1||1.231;var d=s[4];if(h==="%")n*=r/100;if(h==="em")n*=r;if(h==="rem")n*=o;if(d==="px")i=a;if(d==="%")i=n*a/100;if(d==="em")i=n*a;if(d==="rem")i=o*a;if(d===undefined)i=n*a}m[t]=i;return i}function l(t){var i=document.createElement("canvas");var e=i.getContext("2d");var s=t.canvasStyle&&t.canvasStyle.font||"10px sans-serif";e.font=s;i.width=t.width||e.measureText(t.text).width+.5|0;i.height=t.height||u(s)+.5|0;t.width=i.width;t.height=i.height;if(t.canvasStyle){for(var n in t.canvasStyle){e[n]=t.canvasStyle[n]}}e.textBaseline="hanging";if(t.canvasStyle&&t.canvasStyle.strokeStyle){e.strokeText(t.text,0,0)}e.fillText(t.text,0,0);return i}function c(){this.stage.context.clearRect(0,0,this.width,this.height);var t=this._hasMedia?this.media.currentTime:Date.now()/1e3;var i=null;var e=0;for(e=this.runningList.length-1;e>=0;e--){i=this.runningList[e];if(t-i.time>this.duration){i.canvas=null;this.runningList.splice(e,1)}}while(this.position<this.comments.length&&this.comments[this.position].time<t){i=this.comments[this.position];i.canvas=l(i);i.y=s.call(this,i);if(i.mode==="top"||i.mode==="bottom"){i.x=this.width-i.width>>1}this.runningList.push(i);++this.position}var n=this.runningList.length;for(e=0;e<n;e++){i=this.runningList[e];var h=(this.width+i.width)*(t-i.time)/this.duration;if(i.mode==="ltr")i.x=h-i.width+.5|0;if(i.mode==="rtl")i.x=this.width-h+.5|0;this.stage.context.drawImage(i.canvas,i.x,i.y)}}var f=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)};var g=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||clearTimeout;function v(){if(!this.visible||!this.paused){return this}var t=this;var i=this._useCanvas?c:a;function e(){i.call(t);t._requestID=f(e)}this.paused=false;this._requestID=f(e);return this}function p(){if(!this.visible||this.paused){return this}this.paused=true;g(this._requestID);this._requestID=0;return this}function w(){if(this._useCanvas){this.stage.context.clearRect(0,0,this.width,this.height);for(var t=this.runningList.length-1;t>=0;t--){this.runningList[t].canvas=null}}else{var i=this.stage.lastChild;while(i){this.stage.removeChild(i);i=this.stage.lastChild}}this.runningList=[];return this}function y(t,i,e){var s=0;var n=0;var h=t.length;while(n<h){s=n+h>>1;if(e<=t[s][i]){h=s-1}else{n=s+1}}return Math.max(0,h)}function x(){var t=this._hasMedia?this.media.currentTime:Date.now()/1e3;w.call(this);e();this.position=y(this.comments,"time",t);return this}function _(t){if(!/^(ltr|top|bottom)$/i.test(t)){return"rtl"}return t.toLowerCase()}function b(t){t.prototype.init=function(t){if(this._isInited){return this}if(!t.video&&!t.container){throw new Error("Danmaku requires container when initializing.")}this._hasInitContainer=!!t.container;this.container=t.container;this.visible=true;this.engine=(t.engine||"DOM").toLowerCase();this._useCanvas=this.engine==="canvas";this._requestID=0;this._speed=Math.max(0,t.speed)||144;this.duration=4;this.comments=JSON.parse(JSON.stringify(t.comments||[]));this.comments.sort(function(t,i){return t.time-i.time});for(var i=this.comments.length-1;i>=0;i--){this.comments[i].mode=_(this.comments[i].mode)}this.runningList=[];this.position=0;this.paused=true;this.media=t.video||t.audio;this._hasMedia=!!this.media;this._hasVideo=!!t.video;if(this._hasVideo&&!this._hasInitContainer){var e=!this.media.paused;this.container=document.createElement("div");this.container.style.position=this.media.style.position;this.media.style.position="absolute";this.media.parentNode.insertBefore(this.container,this.media);this.container.appendChild(this.media);if(e&&this.media.paused){this.media.play()}}if(this._hasMedia){this.media.addEventListener("play",v.bind(this));this.media.addEventListener("pause",p.bind(this));this.media.addEventListener("seeking",x.bind(this))}if(this._useCanvas){this.stage=document.createElement("canvas");this.stage.context=this.stage.getContext("2d");this.stage.style.cssText="pointer-events:none;position:absolute;"}else{this.stage=document.createElement("div");this.stage.style.cssText="position:relative;overflow:hidden;"+"pointer-events:none;transform:translateZ(0);"}this.resize();this.container.appendChild(this.stage);d(document.getElementsByTagName("html")[0]);d(this.container);if(!this._hasMedia||!this.media.paused){x.call(this);v.call(this)}this._isInited=true;return this}}function C(t){t.prototype.emit=function(t){t.mode=_(t.mode);if(this._hasMedia){var i=this.media.currentTime;t.time=t.time||i;this.comments.splice(y(this.comments,"time",i)+1,0,t)}else{t.time=Date.now()/1e3;this.comments.push(t)}return this}}function L(t){t.prototype.show=function(){if(this.visible){return this}this.visible=true;x.call(this);v.call(this);return this}}function T(t){t.prototype.hide=function(){if(!this.visible){return this}p.call(this);w.call(this);this.visible=false;return this}}function D(t){t.prototype.resize=function(){if(this._hasInitContainer){this.width=this.container.offsetWidth;this.height=this.container.offsetHeight}if(this._hasVideo&&(!this._hasInitContainer||!this.width||!this.height)){this.width=this.media.clientWidth;this.height=this.media.clientHeight}if(this._useCanvas){this.stage.width=this.width;this.stage.height=this.height}else{this.stage.style.width=this.width+"px";this.stage.style.height=this.height+"px"}this.duration=this.width/this._speed;return this}}function I(t){Object.defineProperty(t.prototype,"speed",{get:function(){return this._speed},set:function(t){if(t<=0){return this._speed}this._speed=t;if(this.width){this.duration=this.width/t}return t}})}function M(t){this._isInited=false;t&&this.init(t)}b(M);C(M);L(M);T(M);D(M);I(M);return M});