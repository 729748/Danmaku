(function(t,i){typeof exports==="object"&&typeof module!=="undefined"?module.exports=i():typeof define==="function"&&define.amd?define(i):t.Danmaku=i()})(this,function(){"use strict";function t(){var t=9007199254740991;return[{range:0,time:-t,width:t,height:0},{range:t,time:t,width:0,height:0}]}var i={};function e(){i.ltr=t();i.rtl=t();i.top=t();i.bottom=t()}e();var s=function(t){var e=this;var s=this._hasMedia?this.media.currentTime:Date.now()/1e3;var n=this._hasMedia?this.media.playbackRate:1;function h(t,i){if(i.mode==="top"||i.mode==="bottom"){return s-t.time<e.duration}var h=e.width+t.width;var a=h*(s-t.time)*n/e.duration;var r=e.duration+t.time-s;var o=e.duration*e.width/(e.width+i.width);return r>o||t.width>a}var a=i[t.mode];var r=a.length;var o=0;var d=0;for(var u=1;u<r;u++){var m=a[u];var c=t.height;if(t.mode==="top"||t.mode==="bottom"){c+=m.height}if(m.range-a[o].range>c){d=u;break}if(h(m,t)){o=u}}var l=a[o].range;var f={range:l+t.height,time:this._hasMedia?t.time:t._utc,width:t.width,height:t.height};a.splice(o+1,d-o-1,f);if(t.mode==="bottom"){return this.height-t.height-l%this.height}return l%(this.height-t.height)};var n=function(t){var i=document.createElement("div");i.textContent=t.text;i.style.cssText="position:absolute;white-space:nowrap;";if(t.style){for(var e in t.style){i.style[e]=t.style[e]}}return i};var h=function(){var t=["oTransform","msTransform","mozTransform","webkitTransform","transform"];var i=document.createElement("div").style;for(var e=t.length-1;e>=0;e--){if(t[e]in i){return t[e]}}return"transform"}();var a=function(){var t=Date.now()/1e3;var i=this._hasMedia?this.media.currentTime:t;var e=this._hasMedia?this.media.playbackRate:1;var a=null;var r=0;var o=0;for(o=this.runningList.length-1;o>=0;o--){a=this.runningList[o];r=this._hasMedia?a.time:a._utc;if(i-r>this.duration){this.stage.removeChild(a.node);if(!this._hasMedia){a.node=null}this.runningList.splice(o,1)}}var d=[];var u=document.createDocumentFragment();while(this.position<this.comments.length){a=this.comments[this.position];r=this._hasMedia?a.time:a._utc;if(r>=i){break}a._utc=Date.now()/1e3;a.node=a.node||n(a);this.runningList.push(a);d.push(a);u.appendChild(a.node);++this.position}if(d.length){this.stage.appendChild(u)}for(o=d.length-1;o>=0;o--){a=d[o];a.width=a.width||a.node.offsetWidth;a.height=a.height||a.node.offsetHeight}for(o=d.length-1;o>=0;o--){a=d[o];a.y=s.call(this,a);if(a.mode==="top"||a.mode==="bottom"){a.x=this.width-a.width>>1;a.node.style[h]="translate("+a.x+"px,"+a.y+"px)"}}for(o=this.runningList.length-1;o>=0;o--){a=this.runningList[o];if(a.mode==="top"||a.mode==="bottom"){continue}var m=this.width+a.width;var c=m*(t-a._utc)*e/this.duration;c|=0;if(a.mode==="ltr")a.x=c-a.width;if(a.mode==="rtl")a.x=this.width-c;a.node.style[h]="translate("+a.x+"px,"+a.y+"px)"}};var r=16;var o=16;function d(t){var i=window.getComputedStyle(t,null).getPropertyValue("font-size").match(/(.+)px/)[1]*1;if(t.tagName==="HTML"){o=i}else{r=i}}var u={};var m=function(t){if(u[t]){return u[t]}var i=12;var e=/^(\d+(?:\.\d+)?)(px|%|em|rem)(?:\s*\/\s*(\d+(?:\.\d+)?)(px|%|em|rem)?)?/;var s=t.match(e);if(s){var n=s[1]*1||10;var h=s[2];var a=s[3]*1||1.2;var d=s[4];if(h==="%")n*=r/100;if(h==="em")n*=r;if(h==="rem")n*=o;if(d==="px")i=a;if(d==="%")i=n*a/100;if(d==="em")i=n*a;if(d==="rem")i=o*a;if(d===undefined)i=n*a}u[t]=i;return i};var c=function(t){var i=document.createElement("canvas");var e=i.getContext("2d");var s=t.canvasStyle&&t.canvasStyle.font||"10px sans-serif";e.font=s;t.width=t.width||Math.max(e.measureText(t.text).width|0,1);t.height=t.height||m(s)|0;i.width=t.width;i.height=t.height;e.textBaseline="bottom";var n=t.height;if(t.canvasStyle){for(var h in t.canvasStyle){e[h]=t.canvasStyle[h]}switch(t.canvasStyle.textBaseline){case"top":case"hanging":n=0;break;case"middle":n=t.height>>1;break;default:n=t.height}if(t.canvasStyle.strokeStyle){e.strokeText(t.text,0,n)}}e.fillText(t.text,0,n);return i};var l=function(){this.stage.context.clearRect(0,0,this.width,this.height);var t=Date.now()/1e3;var i=this._hasMedia?this.media.currentTime:t;var e=this._hasMedia?this.media.playbackRate:1;var n=null;var h=0;var a=0;for(a=this.runningList.length-1;a>=0;a--){n=this.runningList[a];h=this._hasMedia?n.time:n._utc;if(i-h>this.duration){n.canvas=null;this.runningList.splice(a,1)}}while(this.position<this.comments.length){n=this.comments[this.position];h=this._hasMedia?n.time:n._utc;if(h>=i){break}n._utc=Date.now()/1e3;n.canvas=c(n);n.y=s.call(this,n);if(n.mode==="top"||n.mode==="bottom"){n.x=this.width-n.width>>1}this.runningList.push(n);++this.position}var r=this.runningList.length;for(a=0;a<r;a++){n=this.runningList[a];var o=this.width+n.width;var d=o*(t-n._utc)*e/this.duration;if(n.mode==="ltr")n.x=d-n.width+.5|0;if(n.mode==="rtl")n.x=this.width-d+.5|0;this.stage.context.drawImage(n.canvas,n.x,n.y)}};var f=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)};var v=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||clearTimeout;var g=function(){if(!this.visible||!this.paused){return this}this.paused=false;if(this._hasMedia){for(var t=this.runningList.length-1;t>=0;t--){var i=this.runningList[t];i._utc=Date.now()/1e3-(this.media.currentTime-i.time)}}var e=this;var s=this._useCanvas?l:a;function n(){s.call(e);e._requestID=f(n)}this._requestID=f(n);return this};var p=function(){if(!this.visible||this.paused){return this}this.paused=true;v(this._requestID);this._requestID=0;return this};var w=function(){if(this._useCanvas){this.stage.context.clearRect(0,0,this.width,this.height);for(var t=this.runningList.length-1;t>=0;t--){this.runningList[t].canvas=null}}else{var i=this.stage.lastChild;while(i){this.stage.removeChild(i);i=this.stage.lastChild}}this.runningList=[];return this};var _=function(t,i,e){var s=0;var n=0;var h=t.length;while(n<h-1){s=n+h>>1;if(e>=t[s][i]){n=s}else{h=s}}if(t[n]&&e<t[n][i]){return n}return h};var y=function(){if(!this._hasMedia){return this}w.call(this);e();var t=_(this.comments,"time",this.media.currentTime);this.position=Math.max(0,t-1);return this};var x=function(t){if(!/^(ltr|top|bottom)$/i.test(t)){return"rtl"}return t.toLowerCase()};var b=function(t){t.prototype.init=function(t){if(this._isInited){return this}if(!t||!t.video&&!t.container){throw new Error("Danmaku requires container when initializing.")}this._hasInitContainer=!!t.container;this.container=t.container;this.visible=true;this.engine=(t.engine||"DOM").toLowerCase();this._useCanvas=this.engine==="canvas";this._requestID=0;this._speed=Math.max(0,t.speed)||144;this.duration=4;this.comments=JSON.parse(JSON.stringify(t.comments||[]));this.comments.sort(function(t,i){return t.time-i.time});for(var i=this.comments.length-1;i>=0;i--){this.comments[i].mode=x(this.comments[i].mode)}this.runningList=[];this.position=0;this.paused=true;this.media=t.video||t.audio;this._hasMedia=!!this.media;this._hasVideo=!!t.video;if(this._hasVideo&&!this._hasInitContainer){var e=!this.media.paused;this.container=document.createElement("div");this.container.style.position=this.media.style.position;this.media.style.position="absolute";this.media.parentNode.insertBefore(this.container,this.media);this.container.appendChild(this.media);if(e&&this.media.paused){this.media.play()}}if(this._hasMedia){this.media.addEventListener("play",g.bind(this));this.media.addEventListener("pause",p.bind(this));this.media.addEventListener("seeking",y.bind(this))}if(this._useCanvas){this.stage=document.createElement("canvas");this.stage.context=this.stage.getContext("2d");this.stage.style.cssText="pointer-events:none;position:absolute;"}else{this.stage=document.createElement("div");this.stage.style.cssText="position:relative;overflow:hidden;"+"pointer-events:none;transform:translateZ(0);"}this.resize();this.container.appendChild(this.stage);d(document.getElementsByTagName("html")[0]);d(this.container);if(!this._hasMedia||!this.media.paused){y.call(this);g.call(this)}this._isInited=true;return this}};var C=function(t){t.prototype.emit=function(t){if(!t||Object.prototype.toString.call(t)!=="[object Object]"){return this}t.text=(t.text||"").toString();t.mode=x(t.mode);t._utc=Date.now()/1e3;if(this._hasMedia){var i=0;if(t.time===undefined){t.time=this.media.currentTime;i=this.position}else{i=_(this.comments,"time",t.time)}this.comments.splice(i,0,t)}else{this.comments.push(t)}return this}};var L=function(t){t.prototype.show=function(){if(this.visible){return this}this.visible=true;if(this._hasMedia&&this.media.paused){return this}y.call(this);g.call(this);return this}};var M=function(t){t.prototype.hide=function(){if(!this.visible){return this}p.call(this);w.call(this);this.visible=false;return this}};var T=function(t){t.prototype.resize=function(){if(this._hasInitContainer){this.width=this.container.offsetWidth;this.height=this.container.offsetHeight}if(this._hasVideo&&(!this._hasInitContainer||!this.width||!this.height)){this.width=this.media.clientWidth;this.height=this.media.clientHeight}if(this._useCanvas){this.stage.width=this.width;this.stage.height=this.height}else{this.stage.style.width=this.width+"px";this.stage.style.height=this.height+"px"}this.duration=this.width/this._speed;return this}};var k=function(t){Object.defineProperty(t.prototype,"speed",{get:function(){return this._speed},set:function(t){if(typeof t!=="number"||isNaN(t)||!isFinite(t)||t<=0){return this._speed}this._speed=t;if(this.width){this.duration=this.width/t}return t}})};function D(t){this._isInited=false;t&&this.init(t)}b(D);C(D);L(D);M(D);T(D);k(D);return D});